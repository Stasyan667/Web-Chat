<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Open Chat EZ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            transition: background 0.5s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        @media (max-width: 768px) {
            body { padding: 5px; }
            .auth-container { padding: 20px; }
            .chat-app { flex-direction: column; }
            .sidebar { width: 100%; height: 50%; border-right: none; border-bottom: 1px solid rgba(230,233,240,0.5); }
            .main-chat { height: 50%; }
            .emoji-picker { grid-template-columns: repeat(6, 1fr); right: 10px; }
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ */
        .auth-container {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            animation: fadeIn 0.5s;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: #667eea;
            position: relative;
        }

        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            width: 100%;
            height: 3px;
            background: #667eea;
            border-radius: 3px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #eef2f6;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .auth-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #eef2f6;
        }

        .auth-divider::before {
            left: 0;
        }

        .auth-divider::after {
            right: 0;
        }

        .auth-divider span {
            background: white;
            padding: 0 10px;
            color: #999;
            font-size: 12px;
        }

        .auth-footer {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-top: 20px;
            position: relative;
        }

        .auth-footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .dev-badge {
            margin-top: 15px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid rgba(102, 126, 234, 0.3);
            transition: all 0.3s;
        }

        .dev-badge:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.02);
        }

        .terms-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .terms-modal.show {
            display: flex;
        }

        .terms-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
        }

        .terms-content h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .terms-content h3 {
            color: #667eea;
            margin: 15px 0 10px;
        }

        .terms-content p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .terms-content ul {
            color: #666;
            margin-left: 20px;
            line-height: 1.6;
        }

        .terms-close {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
        .chat-app {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            position: relative;
        }

        .chat-app.show {
            display: flex;
        }

        /* –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è */
        body.theme-default { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body.theme-dark { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); }
        body.theme-space { background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); }
        body.theme-sunset { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); }
        body.theme-ocean { background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%); }

        .sidebar {
            width: 280px;
            background: rgba(245, 247, 251, 0.9);
            backdrop-filter: blur(5px);
            border-right: 1px solid rgba(230, 233, 240, 0.5);
            display: flex;
            flex-direction: column;
        }

        .profile-section {
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(230, 233, 240, 0.5);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .avatar:hover {
            transform: scale(1.1);
        }
        .avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            border: 2px solid white;
        }

        .profile-info h4 {
            font-size: 16px;
            color: #333;
        }
        .profile-info p {
            font-size: 12px;
            color: #666;
        }

        .edit-profile-btn {
            width: 100%;
            padding: 8px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .edit-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .profile-settings {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        .profile-settings.show {
            display: block;
        }

        .settings-group {
            margin-bottom: 15px;
        }
        .settings-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .settings-group input, .settings-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #eef2f6;
            border-radius: 8px;
            font-size: 14px;
        }

        /* –ü–ª—é—à–∫–∏ - –≤—ã–±–æ—Ä —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è */
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 5px;
        }
        .theme-option {
            height: 35px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .theme-option:hover {
            transform: scale(1.05);
        }
        .theme-option.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        .theme-option.default { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .theme-option.dark { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); }
        .theme-option.space { background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); }
        .theme-option.sunset { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); }
        .theme-option.ocean { background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%); }

        .logout-settings-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .logout-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        /* –≠–º–æ–¥–∑–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏ - –£–ú–ï–ù–¨–®–ï–ù–û */
        .emoji-section {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #eef2f6;
        }
        .emoji-title {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            text-align: center;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            justify-items: center;
        }
        .emoji-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .emoji-item:hover {
            background: #667eea;
            transform: scale(1.1);
            box-shadow: 0 5px 10px rgba(102, 126, 234, 0.3);
        }
        .emoji-item.selected {
            border-color: #667eea;
            background: #e8f0fe;
        }

        /* –§–æ–Ω—ã –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏ - –£–ú–ï–ù–¨–®–ï–ù–û */
        .bg-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        .bg-item {
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .bg-item:hover {
            transform: scale(1.05);
        }
        .bg-item.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        .bg-item.theme-default { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-item.theme-dark { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); }
        .bg-item.theme-space { background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); }
        .bg-item.theme-sunset { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); }
        .bg-item.theme-ocean { background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%); }

        .save-settings {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .save-settings:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        /* –°–µ–∫—Ü–∏—è —á–∞—Ç–æ–≤ */
        .chats-section {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .chats-title {
            font-size: 12px;
            color: #aaa;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            border: 1px solid rgba(230, 233, 240, 0.5);
        }
        .chat-item:hover {
            background: #e8ebf2;
            transform: translateX(3px);
        }
        .chat-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .chat-item.active .chat-users {
            color: white;
        }

        .chat-icon {
            font-size: 24px;
            min-width: 40px;
            text-align: center;
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .chat-users {
            font-size: 11px;
            color: #28a745;
        }

        .create-chat-btn {
            margin-top: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #6c5ce7, #a463f5);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            transition: all 0.3s;
        }
        .create-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(240, 240, 240, 0.8);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .room-info h2 {
            font-size: 20px;
            color: #333;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .online-counter {
            background: #e8f5e9;
            padding: 6px 15px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 14px;
            color: #2e7d32;
            cursor: pointer;
            transition: all 0.3s;
        }
        .online-counter:hover {
            background: #c8e6c9;
            transform: translateY(-2px);
        }

        .users-popup {
            display: none;
            position: absolute;
            top: 70px;
            right: 80px;
            width: 220px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        .users-popup.show {
            display: block;
        }
        .users-popup-header {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .users-list {
            max-height: 250px;
            overflow-y: auto;
            padding: 8px;
        }
        .popup-user-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 6px;
            margin-bottom: 3px;
            background: #f8f9fa;
        }
        .popup-user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .popup-user-name {
            font-weight: 600;
            font-size: 12px;
        }

        .typing-indicator {
            padding: 4px 15px;
            font-size: 11px;
            color: #667eea;
            font-style: italic;
            background: #f0f3f8;
            border-bottom: 1px solid #e0e4e9;
        }

        .messages-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            max-width: 70%;
            animation: fadeIn 0.3s;
            position: relative;
        }
        .message.own {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        .message-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 7px;
            height: 7px;
            background: #4caf50;
            border-radius: 50%;
            border: 2px solid white;
        }
        .message-content {
            background: white;
            padding: 8px 12px;
            border-radius: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            padding-right: 40px;
        }
        .message.own .message-content {
            background: #dcf8c6;
        }
        .message-author {
            font-weight: 600;
            color: #6c5ce7;
            font-size: 11px;
            margin-bottom: 3px;
        }
        .message-text {
            word-break: break-word;
            font-size: 13px;
        }
        .message-time {
            font-size: 9px;
            color: #999;
            margin-top: 3px;
            text-align: right;
        }

        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 3px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .message:hover .message-actions {
            opacity: 1;
        }
        .action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: #f0f3f8;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .action-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }
        .action-btn.delete-own:hover {
            background: #dc3545;
        }
        .action-btn.delete-others:hover {
            background: #ff6b6b;
        }
        .action-btn.reaction:hover {
            background: #28a745;
        }

        .message-reactions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        .reaction-badge {
            background: #f0f3f8;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        .reaction-badge.personal {
            background: #667eea;
            color: white;
        }

        .message-input-area {
            padding: 12px 20px;
            display: flex;
            gap: 10px;
            background: white;
            border-top: 1px solid rgba(240, 240, 240, 0.8);
            align-items: center;
        }
        .emoji-picker-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: #f0f3f8;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .emoji-picker-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }
        .message-input-area input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #eef2f6;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            transition: all 0.3s;
        }
        .message-input-area input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .message-input-area button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c5ce7, #a463f5);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .message-input-area button:hover {
            transform: scale(1.1);
        }

        /* –≠–º–æ–¥–∑–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 10px;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            z-index: 2000;
            max-width: 280px;
            max-height: 180px;
            overflow-y: auto;
        }
        .emoji-picker.show {
            display: grid;
        }
        .emoji-picker span {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }
        .emoji-picker span:hover {
            background: #667eea;
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 25px;
            width: 90%;
            max-width: 320px;
            animation: slideUp 0.3s;
        }

        .dev-panel {
            position: fixed;
            bottom: 50px;
            right: 20px;
            width: 260px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10001;
            display: none;
            overflow: hidden;
            animation: slideUp 0.3s;
        }
        .dev-panel.show {
            display: block;
        }
        .dev-panel-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dev-panel-content {
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
        }
        .dev-user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            border-bottom: 1px solid #eee;
        }
        .dev-user-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dev-user-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }
        .dev-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 10px;
            cursor: pointer;
        }

        .otp-input {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin: 15px 0;
        }
        .otp-digit {
            width: 35px;
            height: 35px;
            border: 2px solid #eef2f6;
            border-radius: 6px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            outline: none;
        }
        .otp-digit:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="theme-default">
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ -->
    <div class="terms-modal" id="termsModal">
        <div class="terms-content">
            <h2>–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Open Chat EZ</h2>
            <h3>1. –£–≤–∞–∂–µ–Ω–∏–µ –∫ –¥—Ä—É–≥–∏–º</h3>
            <p>–ó–∞–ø—Ä–µ—â–µ–Ω—ã –ª—é–±—ã–µ —Ñ–æ—Ä–º—ã –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏–∏, —Ä–∞—Å–∏–∑–º–∞, —Å–µ–∫—Å–∏–∑–º–∞, –≥–æ–º–æ—Ñ–æ–±–∏–∏.</p>
            <h3>2. –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h3>
            <p>–ü–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏—è, –Ω–∞—Å–∏–ª–∏–µ, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, —Å–ø–∞–º.</p>
            <h3>3. –ù–∞–∫–∞–∑–∞–Ω–∏—è</h3>
            <ul>
                <li>1 –Ω–∞—Ä—É—à–µ–Ω–∏–µ: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</li>
                <li>2 –Ω–∞—Ä—É—à–µ–Ω–∏–µ: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ 7 –¥–Ω–µ–π</li>
                <li>3 –Ω–∞—Ä—É—à–µ–Ω–∏–µ: –ü–û–ñ–ò–ó–ù–ï–ù–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê</li>
            </ul>
            <button class="terms-close" onclick="closeTerms()">–ü—Ä–∏–Ω–∏–º–∞—é</button>
        </div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-header">
            <h1>Open Chat EZ</h1>
            <p>–ü—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π —á–∞—Ç</p>
        </div>
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')">–í—Ö–æ–¥</div>
            <div class="auth-tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>
        <div class="auth-form active" id="loginForm">
            <input type="text" class="auth-input" id="loginUsername" placeholder="–ò–º—è">
            <input type="password" class="auth-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="login()">–í–æ–π—Ç–∏</button>
            <div class="auth-divider"><span>–ò–õ–ò</span></div>
            <button class="auth-btn" onclick="quickLogin()">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</button>
        </div>
        <div class="auth-form" id="registerForm">
            <input type="text" class="auth-input" id="registerUsername" placeholder="–ò–º—è">
            <input type="email" class="auth-input" id="registerEmail" placeholder="Email">
            <input type="password" class="auth-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" class="auth-input" id="registerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ">
            <button class="auth-btn" onclick="sendOtp()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
            <div id="otpSection" style="display: none;">
                <div class="otp-input">
                    <input type="text" class="otp-digit" maxlength="1" id="otp1" onkeyup="moveToNext(this, 'otp2')">
                    <input type="text" class="otp-digit" maxlength="1" id="otp2" onkeyup="moveToNext(this, 'otp3')">
                    <input type="text" class="otp-digit" maxlength="1" id="otp3" onkeyup="moveToNext(this, 'otp4')">
                    <input type="text" class="otp-digit" maxlength="1" id="otp4" onkeyup="moveToNext(this, 'otp5')">
                    <input type="text" class="otp-digit" maxlength="1" id="otp5" onkeyup="moveToNext(this, 'otp6')">
                    <input type="text" class="otp-digit" maxlength="1" id="otp6" onkeyup="moveToNext(this, null)">
                </div>
                <button class="auth-btn" onclick="verifyOtp()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
        <div class="auth-footer">
            <div>–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å <a href="#" onclick="showTerms()">—É—Å–ª–æ–≤–∏—è–º–∏</a></div>
            <div class="dev-badge" onclick="openDevModal()">üë®‚Äçüíª Developer</div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <div class="chat-app" id="chatApp">
        <div class="sidebar">
            <div class="profile-section">
                <div class="profile-header">
                    <div class="avatar online" id="avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üòä</div>
                    <div class="profile-info">
                        <h4 id="displayName">–ê–Ω–æ–Ω–∏–º</h4>
                        <p id="displayStatus">‚ö° –≤ —Å–µ—Ç–∏</p>
                    </div>
                </div>
                <button class="edit-profile-btn" onclick="toggleSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
                <div class="profile-settings" id="profileSettings">
                    <div class="emoji-section">
                        <div class="emoji-title">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</div>
                        <div class="emoji-grid" id="emojiGrid"></div>
                    </div>
                    
                    <div class="settings-group">
                        <label>–ò–º—è</label>
                        <input type="text" id="inputName" value="–ê–Ω–æ–Ω–∏–º">
                    </div>
                    
                    <div class="settings-group">
                        <label>–§–æ–Ω –∞–≤–∞—Ç–∞—Ä–∫–∏</label>
                        <div class="bg-grid" id="avatarBgGrid">
                            <div class="bg-item theme-default" onclick="selectAvatarBackground('theme-default', this)"></div>
                            <div class="bg-item theme-dark" onclick="selectAvatarBackground('theme-dark', this)"></div>
                            <div class="bg-item theme-space" onclick="selectAvatarBackground('theme-space', this)"></div>
                            <div class="bg-item theme-sunset" onclick="selectAvatarBackground('theme-sunset', this)"></div>
                            <div class="bg-item theme-ocean" onclick="selectAvatarBackground('theme-ocean', this)"></div>
                        </div>
                    </div>

                    <!-- –ü–ª—é—à–∫–∞ - –≤—ã–±–æ—Ä —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
                    <div class="settings-group">
                        <label>–¢–µ–º–∞ —á–∞—Ç–∞</label>
                        <div class="theme-selector">
                            <div class="theme-option default selected" onclick="selectTheme('theme-default', this)"></div>
                            <div class="theme-option dark" onclick="selectTheme('theme-dark', this)"></div>
                            <div class="theme-option space" onclick="selectTheme('theme-space', this)"></div>
                            <div class="theme-option sunset" onclick="selectTheme('theme-sunset', this)"></div>
                            <div class="theme-option ocean" onclick="selectTheme('theme-ocean', this)"></div>
                        </div>
                    </div>

                    <button class="save-settings" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="logout-settings-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —á–∞—Ç–æ–≤ -->
            <div class="chats-section">
                <div class="chats-title">–î–û–°–¢–£–ü–ù–´–ï –ß–ê–¢–´</div>
                <div id="chatsList">
                    <div class="chat-item active" onclick="switchChat('main', this)">
                        <span class="chat-icon">üí¨</span>
                        <div class="chat-info">
                            <div class="chat-name">–û–±—â–∏–π —á–∞—Ç</div>
                            <div class="chat-users">üë• <span id="mainChatUsers">0</span> –æ–Ω–ª–∞–π–Ω</div>
                        </div>
                    </div>
                </div>
                <div id="customChatsList"></div>
                <button class="create-chat-btn" onclick="openCreateChatModal()">‚ûï –°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
            </div>
        </div>

        <div class="main-chat">
            <div class="chat-header">
                <div class="room-info">
                    <h2 id="currentRoomName">üí¨ –û–±—â–∏–π —á–∞—Ç</h2>
                </div>
                <div class="online-counter" onclick="toggleUsersPopup()">
                    <span>üë•</span> <span id="onlineCount">0</span> –æ–Ω–ª–∞–π–Ω
                </div>
                <div class="users-popup" id="usersPopup">
                    <div class="users-popup-header">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
                    <div class="users-list" id="usersList"></div>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–µ—Ç -->
            <div id="typingIndicator" class="typing-indicator" style="display: none;">üë§ –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç...</div>

            <div class="messages-area" id="messagesArea"></div>

            <div class="message-input-area">
                <button class="emoji-picker-btn" onclick="toggleEmojiPicker()">üòä</button>
                <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()" onkeydown="startTyping()">
                <button onclick="sendMessage()">‚û§</button>
            </div>
            
            <div class="emoji-picker" id="emojiPicker">
                <span onclick="addEmoji('üòä')">üòä</span>
                <span onclick="addEmoji('üòÇ')">üòÇ</span>
                <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span onclick="addEmoji('üëç')">üëç</span>
                <span onclick="addEmoji('üéâ')">üéâ</span>
                <span onclick="addEmoji('üî•')">üî•</span>
                <span onclick="addEmoji('üòé')">üòé</span>
                <span onclick="addEmoji('ü•≥')">ü•≥</span>
                <span onclick="addEmoji('üòç')">üòç</span>
                <span onclick="addEmoji('ü§î')">ü§î</span>
                <span onclick="addEmoji('üëè')">üëè</span>
                <span onclick="addEmoji('üôè')">üôè</span>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ -->
    <div class="modal" id="createChatModal">
        <div class="modal-content">
            <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</h3>
            <input type="text" id="chatNameInput" class="auth-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞">
            <input type="text" id="chatPasswordInput" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeCreateChatModal()" style="flex:1; padding:10px; background:#f0f3f8; border:none; border-radius:10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary" onclick="createChat()" style="flex:1; padding:10px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; border-radius:10px; cursor:pointer;">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —á–∞—Ç—É -->
    <div class="modal" id="joinChatModal">
        <div class="modal-content">
            <h3>üîê –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É</h3>
            <p id="joinChatName"></p>
            <input type="password" id="joinChatPassword" class="auth-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeJoinChatModal()" style="flex:1; padding:10px; background:#f0f3f8; border:none; border-radius:10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary" onclick="joinChat()" style="flex:1; padding:10px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; border-radius:10px; cursor:pointer;">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ -->
    <div class="modal" id="devModal">
        <div class="modal-content">
            <h3>üîê –ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h3>
            <p>–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥:</p>
            <input type="password" id="devCodeInput" class="auth-input" placeholder="******">
            <div id="devError" class="status-error" style="display: none; color: #dc3545; margin: 10px 0; text-align: center;">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeDevModal()" style="flex:1; padding:10px; background:#f0f3f8; border:none; border-radius:10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary" onclick="checkDevCode()" style="flex:1; padding:10px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; border-radius:10px; cursor:pointer;">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>
 
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== –≠–ú–û–î–ó–ò –î–õ–Ø –ê–í–ê–¢–ê–†–ö–ò ==========
        const avatarEmojis = [
            'üòä', 'üòé', 'ü§ì', 'üòá', 'ü•≥', 'üòç', 'üî•', '‚≠ê', 
            'ü¶ä', 'üêº', 'üê®', 'ü¶Å', 'üê±', 'üê∂', 'üê∞', 'üê∏',
            'üå∏', 'üåà', 'üçï', 'üéÆ'
        ];

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let currentUser = null;
        let currentRoom = 'main';
        let rooms = {
            'main': { 
                name: '–û–±—â–∏–π —á–∞—Ç', 
                type: 'public', 
                users: [], 
                messages: [], 
                onlineCount: 0 
            }
        };
        let customRooms = {}; // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —á–∞—Ç–æ–≤
        let messages = []; // –°–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        let onlineUsers = []; // –°–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        let personalReactions = JSON.parse(localStorage.getItem('personalReactions')) || {}; // –õ–∏—á–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏
        let deletedMessages = JSON.parse(localStorage.getItem('deletedMessages')) || {}; // –°–∫—Ä—ã—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const DEV_CODE = "stasyan2024";
        let currentOtp = null;
        let typingTimeout;
        let currentChatToJoin = null;

        // ========== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£ ==========
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        // ========== –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –î–õ–Ø –°–û–ö–ï–¢–ê ==========
        let socketUser = {
            name: '–ê–Ω–æ–Ω–∏–º',
            avatar: 'üòä',
            avatarBackground: 'theme-default'
        };

        // ========== –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–û–ô –°–ï–°–°–ò–ò ==========
        let savedSession = JSON.parse(localStorage.getItem('currentSession'));
        if (savedSession) {
            currentUser = savedSession;
            socketUser = {
                name: currentUser.name,
                avatar: currentUser.avatar,
                avatarBackground: currentUser.avatarBackground
            };
            showChat();
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–´–• –ß–ê–¢–û–í ==========
        let savedChats = JSON.parse(localStorage.getItem('customChats')) || {};
        customRooms = savedChats;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        function updateChatsList() {
            let listDiv = document.getElementById('customChatsList');
            if (!listDiv) return;
            
            listDiv.innerHTML = '';
            
            // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–π —á–∞—Ç (–æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ chatsList)
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —á–∞—Ç—ã
            for (let [roomId, room] of Object.entries(customRooms)) {
                let div = document.createElement('div');
                div.className = 'chat-item';
                if (roomId === currentRoom) div.classList.add('active');
                div.setAttribute('data-roomid', roomId);
                div.innerHTML = `
                    <span class="chat-icon">üîí</span>
                    <div class="chat-info">
                        <div class="chat-name">${room.name}</div>
                        <div class="chat-users">üë• ${room.onlineCount || 0} –æ–Ω–ª–∞–π–Ω</div>
                    </div>
                `;
                div.onclick = () => joinCustomChat(roomId, room.name, room.password);
                listDiv.appendChild(div);
            }
        }

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É —á–∞—Ç—É
        function joinCustomChat(roomId, roomName, hasPassword) {
            if (hasPassword) {
                currentChatToJoin = { id: roomId, name: roomName };
                document.getElementById('joinChatName').innerText = `–ß–∞—Ç: ${roomName}`;
                document.getElementById('joinChatModal').classList.add('show');
            } else {
                switchRoom(roomId);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        function switchRoom(roomId) {
            currentRoom = roomId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            let activeEl = document.querySelector(`[data-roomid="${roomId}"]`);
            if (activeEl) activeEl.classList.add('active');
            if (roomId === 'main') {
                document.querySelector('.chat-item.active')?.classList.remove('active');
                document.querySelector('.chat-item[onclick*="main"]')?.classList.add('active');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —à–∞–ø–∫–µ
            let roomName = roomId === 'main' ? '–û–±—â–∏–π —á–∞—Ç' : (customRooms[roomId]?.name || '–ß–∞—Ç');
            document.getElementById('currentRoomName').innerHTML = roomId === 'main' ? 'üí¨ –û–±—â–∏–π —á–∞—Ç' : `üîí ${roomName}`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
            loadRoomMessages(roomId);
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç
            joinRoomSocket(roomId);
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showTerms() { document.getElementById('termsModal').classList.add('show'); }
        function closeTerms() { document.getElementById('termsModal').classList.remove('show'); }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(el => el.classList.remove('active'));
            if (tab === 'login') {
                document.querySelector('.auth-tab').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        // ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==========
        function quickLogin() {
            let testUser = {
                id: Date.now(),
                username: '–ì–æ—Å—Ç—å_' + Math.floor(Math.random() * 1000),
                name: '–ì–æ—Å—Ç—å_' + Math.floor(Math.random() * 1000),
                email: 'guest@guest.com',
                avatar: 'üòä',
                avatarBackground: 'theme-default',
                isAdmin: false,
                isDev: false
            };
            users.push(testUser);
            try {
                let usersJSON = JSON.stringify(users);
                if (usersJSON.length < 5000000) {
                    localStorage.setItem('users', JSON.stringify(users));
                } else {
                    let recentUsers = users.slice(-100);
                    localStorage.setItem('users', JSON.stringify(recentUsers));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
            currentUser = testUser;
            socketUser = { 
                name: testUser.name, 
                avatar: testUser.avatar,
                avatarBackground: testUser.avatarBackground
            };
            localStorage.setItem('currentSession', JSON.stringify(currentUser));
            showChat();
        }

        function sendOtp() {
            let username = document.getElementById('registerUsername').value.trim();
            let email = document.getElementById('registerEmail').value.trim();
            let password = document.getElementById('registerPassword').value;
            let confirm = document.getElementById('registerConfirmPassword').value;
            
            if (!username || !email || !password || !confirm) { 
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); 
                return; 
            }
            if (password !== confirm) { 
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); 
                return; 
            }
            
            currentOtp = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('‚úÖ –í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', currentOtp);
            alert(`üìß –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ${email}\n\n–î–ª—è —Ç–µ—Å—Ç–∞: ${currentOtp}`);
            document.getElementById('otpSection').style.display = 'block';
        }

        function moveToNext(current, nextId) {
            if (current.value.length >= 1 && nextId) {
                document.getElementById(nextId).focus();
            }
        }

        function verifyOtp() {
            let otp1 = document.getElementById('otp1').value;
            let otp2 = document.getElementById('otp2').value;
            let otp3 = document.getElementById('otp3').value;
            let otp4 = document.getElementById('otp4').value;
            let otp5 = document.getElementById('otp5').value;
            let otp6 = document.getElementById('otp6').value;
            let enteredOtp = otp1 + otp2 + otp3 + otp4 + otp5 + otp6;
            
            if (enteredOtp === currentOtp) {
                completeRegistration();
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
            }
        }

        function completeRegistration() {
            let username = document.getElementById('registerUsername').value.trim();
            let email = document.getElementById('registerEmail').value.trim();
            let password = document.getElementById('registerPassword').value;
            
            let newUser = {
                id: Date.now(),
                username: username,
                email: email,
                password: password,
                name: username,
                avatar: 'üòä',
                avatarBackground: 'theme-default',
                isAdmin: false,
                isDev: false
            };
            
            users.push(newUser);
            try {
                let usersJSON = JSON.stringify(users);
                if (usersJSON.length < 5000000) {
                    localStorage.setItem('users', JSON.stringify(users)); 
                } else {
                    let recentUsers = users.slice(-100);
                    localStorage.setItem('users', JSON.stringify(recentUsers));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }

            currentUser = newUser;
            socketUser = { 
                name: newUser.name, 
                avatar: newUser.avatar,
                avatarBackground: newUser.avatarBackground
            };
            localStorage.setItem('currentSession', JSON.stringify(currentUser));
            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
            showChat();
        }

        function login() {
            let username = document.getElementById('loginUsername').value.trim();
            let password = document.getElementById('loginPassword').value;
            let user = users.find(u => u.username === username && u.password === password);
            if (!user) { alert('‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); return; }
            currentUser = user;
            socketUser = { 
                name: user.name, 
                avatar: user.avatar,
                avatarBackground: user.avatarBackground
            };
            localStorage.setItem('currentSession', JSON.stringify(currentUser));
            showChat();
        }

        function logout() {
            localStorage.removeItem('currentSession');
            currentUser = null;
            document.getElementById('chatApp').classList.remove('show');
            document.getElementById('authContainer').style.display = 'block';
        }

        function showChat() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('chatApp').classList.add('show');
            document.getElementById('displayName').innerText = currentUser.name;
            document.getElementById('avatar').innerText = currentUser.avatar;
            document.getElementById('avatar').style.background = getGradientByTheme(currentUser.avatarBackground || 'theme-default');
            document.getElementById('inputName').value = currentUser.name;
            loadEmojis();
            updateChatsList();
            addSystemMessage('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Open Chat EZ!');
            
            socket.emit('user:register', socketUser);
            joinRoomSocket('main');
        }

        // ========== –ù–ê–°–¢–†–û–ô–ö–ò –ü–†–û–§–ò–õ–Ø ==========
        function toggleSettings() { document.getElementById('profileSettings').classList.toggle('show'); }

        function saveProfile() {
            currentUser.name = document.getElementById('inputName').value;
            
            document.getElementById('displayName').innerText = currentUser.name;
            document.getElementById('displayStatus').innerHTML = '‚ö° –≤ —Å–µ—Ç–∏';
            
            socketUser.name = currentUser.name;
            socket.emit('user:register', socketUser);
            
            toggleSettings();
            try {
                let usersJSON = JSON.stringify(users);
                if (usersJSON.length < 5000000) {
                    localStorage.setItem('users', JSON.stringify(users));
                } else {
                    let recentUsers = users.slice(-100);
                    localStorage.setItem('users', JSON.stringify(recentUsers));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
            
            let userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function selectAvatarBackground(theme, element) {
            document.querySelectorAll('.bg-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            currentUser.avatarBackground = theme;
            document.getElementById('avatar').style.background = getGradientByTheme(theme);
            socketUser.avatarBackground = theme;
            socket.emit('user:register', socketUser);
        }

        function getGradientByTheme(theme) {
            const gradients = {
                'theme-default': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'theme-dark': 'linear-gradient(135deg, #2c3e50 0%, #3498db 100%)',
                'theme-space': 'linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%)',
                'theme-sunset': 'linear-gradient(135deg, #ff6b6b 0%, #feca57 100%)',
                'theme-ocean': 'linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%)'
            };
            return gradients[theme] || gradients['theme-default'];
        }

        function selectTheme(theme, element) {
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.body.className = theme;
        }

        function loadEmojis() {
            let grid = document.getElementById('emojiGrid');
            if (!grid) return;
            grid.innerHTML = '';
            avatarEmojis.forEach(emoji => {
                let div = document.createElement('div');
                div.className = 'emoji-item';
                div.innerText = emoji;
                div.onclick = function() {
                    document.querySelectorAll('.emoji-item').forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                    currentUser.avatar = emoji;
                    socketUser.avatar = emoji;
                    document.getElementById('avatar').innerText = emoji;
                    socket.emit('user:register', socketUser);
                };
                grid.appendChild(div);
            });
        }

        // ========== –ß–ê–¢ ==========
        function sendMessage() {
            let input = document.getElementById('messageInput');
            let text = input.value.trim();
            if (!text) return;
            
            let time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let tempId = 'temp_' + Date.now() + '_' + Math.random();
            
            let tempMessage = {
                id: tempId,
                author: currentUser.name,
                text: text,
                time: time,
                avatarBg: currentUser.avatarBackground,
                avatar: currentUser.avatar,
                isTemp: true,
                timestamp: Date.now(),
                roomId: currentRoom
            };
            
            if (!rooms[currentRoom]) {
                if (currentRoom === 'main') {
                    rooms[currentRoom] = { messages: [] };
                } else {
                    rooms[currentRoom] = customRooms[currentRoom] || { messages: [] };
                }
            }
            
            if (!rooms[currentRoom].messages) rooms[currentRoom].messages = [];
            rooms[currentRoom].messages.push(tempMessage);
            
            addMessageToUI(
                currentUser.name, 
                text, 
                time, 
                true, 
                currentUser.avatarBackground, 
                tempId, 
                {}, 
                currentUser.avatar
            );
            
            input.value = '';
            
            socket.emit('message:send', { 
                text: text,
                tempId: tempId,
                roomId: currentRoom
            });
            
            stopTyping();
        }

        function addMessageToUI(author, text, time, isOwn, avatarBg, messageId, reactions, authorAvatar) {
            let area = document.getElementById('messagesArea');
            if (!area) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–∫—Ä—ã—Ç–æ –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (deletedMessages[messageId] && deletedMessages[messageId] === currentUser.name) {
                return; // –°–∫—Ä—ã—Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            }
            
            let div = document.createElement('div');
            div.className = 'message' + (isOwn ? ' own' : '');
            div.id = `msg-${messageId}`;
            div.setAttribute('data-message-id', messageId);
            div.setAttribute('data-author', author);
            
            if (!currentUser) return;
            
            let bgGradient = isOwn 
                ? getGradientByTheme(currentUser.avatarBackground) 
                : getGradientByTheme(avatarBg || 'theme-default');
            
            let avatar = isOwn 
                ? (currentUser.avatar || 'üë§') 
                : (authorAvatar && authorAvatar !== 'undefined' ? authorAvatar : 'üë§');
            
            let escapedText = escapeHtml(text);
            let escapedAuthor = escapeHtml(author);
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            let actionsHtml = '<div class="message-actions">';
            
            // –ö–Ω–æ–ø–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏ (–¥–ª—è –≤—Å–µ—Ö)
            actionsHtml += `<button class="action-btn reaction" onclick="showReactionMenu('${messageId}', event)">üòä</button>`;
            
            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            if (isOwn) {
                actionsHtml += `<button class="action-btn delete-own" onclick="deleteMessageForAll('${messageId}', event)">üóëÔ∏è</button>`;
            } else {
                // –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∏—è (–¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —É —Å–µ–±—è)
                actionsHtml += `<button class="action-btn delete-others" onclick="hideMessageForMe('${messageId}', event)">üëÅÔ∏è</button>`;
            }
            
            actionsHtml += '</div>';
            
            // –õ–∏—á–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏
            let personalReactionsHtml = '';
            if (personalReactions[messageId] && personalReactions[messageId][currentUser.name]) {
                personalReactionsHtml = '<div class="message-reactions">';
                personalReactions[messageId][currentUser.name].forEach(emoji => {
                    personalReactionsHtml += `<span class="reaction-badge personal">${emoji}</span>`;
                });
                personalReactionsHtml += '</div>';
            }
            
            div.innerHTML = `
                <div class="message-avatar" style="background: ${bgGradient}">${avatar}</div>
                <div class="message-content">
                    <div class="message-author">${escapedAuthor}</div>
                    <div class="message-text">${escapedText}</div>
                    ${personalReactionsHtml}
                    <div class="message-time">${escapeHtml(time || '')}</div>
                    ${actionsHtml}
                </div>
            `;
            
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function addSystemMessage(text) {
            let area = document.getElementById('messagesArea');
            let div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<div class="message-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ü§ñ</div><div class="message-content"><div class="message-text">${text}</div></div>`;
            area.appendChild(div);
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö (—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏)
        function deleteMessageForAll(messageId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (!currentUser) return;
            
            let messageElement = document.getElementById(`msg-${messageId}`);
            if (!messageElement) return;
            
            let author = messageElement.getAttribute('data-author');
            
            if (author !== currentUser.name && !currentUser.isDev && !currentUser.isAdmin) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö?')) {
                messageElement.remove();
                
                if (rooms[currentRoom] && rooms[currentRoom].messages) {
                    rooms[currentRoom].messages = rooms[currentRoom].messages.filter(msg => msg.id != messageId);
                }
                
                socket.emit('message:delete', {
                    messageId: messageId,
                    roomId: currentRoom
                });
            }
        }

        // –°–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è
        function hideMessageForMe(messageId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (!currentUser) return;
            
            let messageElement = document.getElementById(`msg-${messageId}`);
            if (!messageElement) return;
            
            if (confirm('–°–∫—Ä—ã—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±—É–¥–µ—Ç –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∞–º)?')) {
                messageElement.remove();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage, —á—Ç–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (!deletedMessages[messageId]) {
                    deletedMessages[messageId] = currentUser.name;
                    localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
                }
            }
        }

        // –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∞–∫—Ü–∏–∏
        function showReactionMenu(messageId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            let menu = document.createElement('div');
            menu.style.position = 'absolute';
            menu.style.background = 'white';
            menu.style.borderRadius = '20px';
            menu.style.padding = '8px';
            menu.style.boxShadow = '0 5px 20px rgba(0,0,0,0.2)';
            menu.style.zIndex = '5000';
            menu.style.display = 'flex';
            menu.style.gap = '5px';
            
            let reactions = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°'];
            reactions.forEach(r => {
                let btn = document.createElement('span');
                btn.innerText = r;
                btn.style.fontSize = '20px';
                btn.style.cursor = 'pointer';
                btn.style.padding = '3px';
                btn.onclick = () => {
                    addPersonalReaction(messageId, r);
                    menu.remove();
                };
                menu.appendChild(btn);
            });
            
            document.body.appendChild(menu);
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            
            setTimeout(() => menu.remove(), 3000);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π —Ä–µ–∞–∫—Ü–∏–∏
        function addPersonalReaction(messageId, emoji) {
            if (!currentUser) return;
            
            if (!personalReactions[messageId]) {
                personalReactions[messageId] = {};
            }
            if (!personalReactions[messageId][currentUser.name]) {
                personalReactions[messageId][currentUser.name] = [];
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞)
            if (!personalReactions[messageId][currentUser.name].includes(emoji)) {
                personalReactions[messageId][currentUser.name].push(emoji);
                localStorage.setItem('personalReactions', JSON.stringify(personalReactions));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                let messageElement = document.getElementById(`msg-${messageId}`);
                if (messageElement) {
                    let reactionsDiv = messageElement.querySelector('.message-reactions');
                    if (reactionsDiv) {
                        reactionsDiv.innerHTML += `<span class="reaction-badge personal">${emoji}</span>`;
                    } else {
                        let newReactionsDiv = document.createElement('div');
                        newReactionsDiv.className = 'message-reactions';
                        newReactionsDiv.innerHTML = `<span class="reaction-badge personal">${emoji}</span>`;
                        messageElement.querySelector('.message-content').appendChild(newReactionsDiv);
                    }
                }
            }
        }

        // ========== –ü–õ–Æ–®–ö–ê: –ò–ù–î–ò–ö–ê–¢–û–† –ü–ï–ß–ê–¢–ê–ï–¢ ==========
        function startTyping() {
            socket.emit('typing:start', { roomId: currentRoom });
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('typing:stop', { roomId: currentRoom });
            }, 2000);
        }

        function stopTyping() {
            clearTimeout(typingTimeout);
            socket.emit('typing:stop', { roomId: currentRoom });
        }

        // ========== –°–û–ó–î–ê–ù–ò–ï –ß–ê–¢–û–í ==========
        function openCreateChatModal() {
            document.getElementById('createChatModal').classList.add('show');
            document.getElementById('chatNameInput').value = '';
            document.getElementById('chatPasswordInput').value = '';
        }

        function closeCreateChatModal() {
            document.getElementById('createChatModal').classList.remove('show');
        }

        function createChat() {
            let name = document.getElementById('chatNameInput').value.trim();
            let password = document.getElementById('chatPasswordInput').value.trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞');
                return;
            }
            
            let roomId = 'chat_' + Date.now();
            
            customRooms[roomId] = {
                name: name,
                password: password || null,
                users: [],
                messages: [],
                onlineCount: 0
            };
            
            localStorage.setItem('customChats', JSON.stringify(customRooms));
            
            updateChatsList();
            closeCreateChatModal();
            
            // –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—è –Ω–µ—Ç, —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
            if (!password) {
                switchRoom(roomId);
            }
            
            socket.emit('room:create', { name, password, roomId });
        }

        function closeJoinChatModal() {
            document.getElementById('joinChatModal').classList.remove('show');
            currentChatToJoin = null;
        }

        function joinChat() {
            if (!currentChatToJoin) return;
            
            let password = document.getElementById('joinChatPassword').value.trim();
            let room = customRooms[currentChatToJoin.id];
            
            if (room.password && room.password !== password) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            switchRoom(currentChatToJoin.id);
            closeJoinChatModal();
        }

        // ========== –≠–ú–û–î–ó–ò ==========
        function toggleEmojiPicker() { document.getElementById('emojiPicker').classList.toggle('show'); }
        function addEmoji(emoji) { document.getElementById('messageInput').value += emoji; }

        function toggleUsersPopup() { document.getElementById('usersPopup').classList.toggle('show'); }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –ö–û–ú–ù–ê–¢–´ ==========
        function loadRoomMessages(roomId) {
            let area = document.getElementById('messagesArea');
            area.innerHTML = '';
            
            let roomMessages = [];
            if (roomId === 'main') {
                roomMessages = rooms['main']?.messages || [];
            } else {
                roomMessages = customRooms[roomId]?.messages || [];
            }
            
            if (roomMessages && roomMessages.length > 0) {
                let sortedMessages = [...roomMessages].sort((a, b) => {
                    return (a.timestamp || 0) - (b.timestamp || 0);
                });
                
                sortedMessages.forEach(msg => {
                    if (msg.isTemp) return;
                    
                    addMessageToUI(
                        msg.author, 
                        msg.text, 
                        msg.time, 
                        msg.author === currentUser.name,
                        msg.avatarBg, 
                        msg.id, 
                        msg.reactions,
                        msg.avatar
                    );
                });
            } else {
                addSystemMessage('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç!');
            }
        }

        // ========== –°–û–ö–ï–¢ –°–û–ë–´–¢–ò–Ø ==========
        function joinRoomSocket(roomId) {
            if (!socket) return;
            
            socket.emit('room:join', roomId, (data) => {
                if (data && data.error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', data.error);
                    addSystemMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ');
                    return;
                }
                
                if (data && data.users) {
                    onlineUsers = data.users;
                    updateUsersPopup(data.users);
                    let count = data.onlineCount || data.users.length;
                    document.getElementById('onlineCount').innerText = count;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
                    if (roomId === 'main') {
                        document.getElementById('mainChatUsers').innerText = count;
                    } else if (customRooms[roomId]) {
                        customRooms[roomId].onlineCount = count;
                        updateChatsList();
                    }
                }
                
                if (data && data.messages) {
                    if (roomId === 'main') {
                        rooms['main'].messages = data.messages;
                    } else if (customRooms[roomId]) {
                        customRooms[roomId].messages = data.messages;
                    }
                    loadRoomMessages(roomId);
                }
            });
        }

        socket.on('message:new', (message) => {
            if (!currentUser) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∫–æ–º–Ω–∞—Ç–µ
            if (message.roomId === 'main') {
                if (!rooms['main'].messages) rooms['main'].messages = [];
                rooms['main'].messages.push(message);
            } else if (customRooms[message.roomId]) {
                if (!customRooms[message.roomId].messages) customRooms[message.roomId].messages = [];
                customRooms[message.roomId].messages.push(message);
            }
            
            if (message.roomId === currentRoom && message.author !== currentUser.name) {
                addMessageToUI(
                    message.author, 
                    message.text, 
                    message.time, 
                    false, 
                    message.avatarBg, 
                    message.id, 
                    message.reactions,
                    message.avatar
                );
            }
        });

        socket.on('message:saved', (data) => {
            let tempElement = document.getElementById(`msg-${data.tempId}`);
            if (tempElement) {
                tempElement.id = `msg-${data.realId}`;
                tempElement.setAttribute('data-message-id', data.realId);
                
                let deleteBtn = tempElement.querySelector('.delete-own');
                if (deleteBtn) {
                    deleteBtn.setAttribute('onclick', `deleteMessageForAll('${data.realId}', event)`);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º ID –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                let roomMessages = currentRoom === 'main' ? rooms['main'].messages : customRooms[currentRoom]?.messages;
                if (roomMessages) {
                    let tempIndex = roomMessages.findIndex(m => m.id === data.tempId);
                    if (tempIndex !== -1) {
                        roomMessages[tempIndex].id = data.realId;
                        delete roomMessages[tempIndex].isTemp;
                    }
                }
            }
        });

        socket.on('online:update', (data) => {
            if (data.roomId === currentRoom) {
                document.getElementById('onlineCount').innerText = data.count || 0;
            }
            if (data.roomId === 'main') {
                document.getElementById('mainChatUsers').innerText = data.count || 0;
            } else if (customRooms[data.roomId]) {
                customRooms[data.roomId].onlineCount = data.count || 0;
                updateChatsList();
            }
        });

        socket.on('user:joined', (data) => {
            if (!currentUser || !data) return;
            if (data.name !== currentUser.name && data.roomId === currentRoom) {
                addSystemMessage(`‚ú® ${data.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É`);
            }
        });

        socket.on('user:left', (data) => {
            if (!currentUser || !data) return;
            if (data.name !== currentUser.name && data.roomId === currentRoom) {
                addSystemMessage(`üëã ${data.name} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`);
            }
        });

        socket.on('message:deleted', (data) => {
            const { messageId, roomId } = data;
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ –ø–∞–º—è—Ç–∏
            if (roomId === 'main' && rooms['main'].messages) {
                rooms['main'].messages = rooms['main'].messages.filter(msg => msg.id != messageId);
            } else if (customRooms[roomId] && customRooms[roomId].messages) {
                customRooms[roomId].messages = customRooms[roomId].messages.filter(msg => msg.id != messageId);
            }
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ DOM, –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞
            if (roomId === currentRoom) {
                let messageElement = document.getElementById(`msg-${messageId}`);
                if (messageElement) {
                    messageElement.remove();
                }
            }
        });

        // –ü–ª—é—à–∫–∞: –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–µ—Ç
        socket.on('typing:start', (data) => {
            if (data.userName !== currentUser.name && data.roomId === currentRoom) {
                let indicator = document.getElementById('typingIndicator');
                indicator.innerHTML = `‚úçÔ∏è ${data.userName} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
                indicator.style.display = 'block';
            }
        });

        socket.on('typing:stop', (data) => {
            if (data.userName !== currentUser.name && data.roomId === currentRoom) {
                document.getElementById('typingIndicator').style.display = 'none';
            }
        });

        socket.on('room:created', (data) => {
            console.log('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞:', data);
        });

        function updateUsersPopup(users) {
            let list = document.getElementById('usersList');
            if (!list) return;
            list.innerHTML = '';
            users.forEach(user => {
                let div = document.createElement('div');
                div.className = 'popup-user-item';
                div.innerHTML = `<div class="popup-user-avatar" style="background: ${getGradientByTheme(user.avatarBackground || 'theme-default')}">${user.avatar || 'üë§'}</div><div class="popup-user-name">${user.name}</div>`;
                list.appendChild(div);
            });
        }

        // ========== –ü–ê–ù–ï–õ–¨ –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–ê ==========
        function openDevModal() {
            document.getElementById('devModal').classList.add('show');
            document.getElementById('devCodeInput').value = '';
            document.getElementById('devError').style.display = 'none';
        }

        function closeDevModal() {
            document.getElementById('devModal').classList.remove('show');
        }

        function checkDevCode() {
            let code = document.getElementById('devCodeInput').value;
            if (code === DEV_CODE) {
                closeDevModal();
                enableDevMode();
            } else {
                document.getElementById('devError').style.display = 'block';
            }
        }

        function enableDevMode() {
            if (currentUser) {
                currentUser.isDev = true;
                currentUser.isAdmin = true;
                alert('‚úÖ –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å –ª—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
                loadRoomMessages(currentRoom);
                showDevPanel();
            } else {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —á–∞—Ç');
                closeDevModal();
            }
        }

        function showDevPanel() {
            if (document.getElementById('devPanel')) {
                document.getElementById('devPanel').remove();
            }
            
            let panel = document.createElement('div');
            panel.id = 'devPanel';
            panel.className = 'dev-panel show';
            
            panel.innerHTML = `
                <div class="dev-panel-header">
                    <span>üë®‚Äçüíª Dev Panel</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;">√ó</button>
                </div>
                <div class="dev-panel-content">
                    <div style="margin-bottom:10px; padding:8px; background:#f0f3f8; border-radius:8px; font-size:12px;">
                        <strong>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</strong>
                    </div>
                    <div id="devUsersList"></div>
                </div>
            `;
            
            document.body.appendChild(panel);
            updateDevUsersList();
        }

        function updateDevUsersList() {
            let listDiv = document.getElementById('devUsersList');
            if (!listDiv) return;
            
            listDiv.innerHTML = '';
            onlineUsers.forEach(user => {
                if (!user || !user.name) return;
                
                let div = document.createElement('div');
                div.className = 'dev-user-item';
                div.innerHTML = `
                    <div class="dev-user-info">
                        <div class="dev-user-avatar" style="background: ${getGradientByTheme(user.avatarBackground || 'theme-default')}">${user.avatar || 'üë§'}</div>
                        <span class="dev-user-name">${user.name}</span>
                    </div>
                    ${user.name !== currentUser?.name ? `<button class="dev-delete-btn" onclick="deleteAllUserMessages('${user.name}')">üóëÔ∏è –í—Å–µ</button>` : ''}
                `;
                listDiv.appendChild(div);
            });
        }

        function deleteAllUserMessages(username) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) return;
            
            let roomMessages = currentRoom === 'main' ? rooms['main'].messages : customRooms[currentRoom]?.messages;
            if (!roomMessages) return;
            
            let userMessages = roomMessages.filter(msg => msg.author === username);
            
            userMessages.forEach(msg => {
                let msgElement = document.getElementById(`msg-${msg.id}`);
                if (msgElement) msgElement.remove();
                
                socket.emit('message:delete', {
                    messageId: msg.id,
                    roomId: currentRoom
                });
            });
            
            roomMessages = roomMessages.filter(msg => msg.author !== username);
            if (currentRoom === 'main') {
                rooms['main'].messages = roomMessages;
            } else {
                customRooms[currentRoom].messages = roomMessages;
            }
            
            alert(`‚úÖ –£–¥–∞–ª–µ–Ω–æ ${userMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π`);
            updateDevUsersList();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–ø–∞–ø–æ–≤
        document.addEventListener('click', function(e) {
            let picker = document.getElementById('emojiPicker');
            let btn = document.querySelector('.emoji-picker-btn');
            if (picker && picker.classList.contains('show') && !picker.contains(e.target) && !btn?.contains(e.target)) {
                picker.classList.remove('show');
            }
            let popup = document.getElementById('usersPopup');
            let counter = document.querySelector('.online-counter');
            if (popup && popup.classList.contains('show') && !popup.contains(e.target) && !counter?.contains(e.target)) {
                popup.classList.remove('show');
            }
        });
    </script>
</body>
</html>